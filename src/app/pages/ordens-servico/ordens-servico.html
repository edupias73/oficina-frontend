<div class="page-container">
  <div class="page-toolbar">
    <div class="toolbar-left">
      <h1>Ordens de Servi√ßo</h1>
      <p>Gerencie os servi√ßos e or√ßamentos da oficina.</p>
    </div>

    <div class="toolbar-actions">
      <div class="search-box">
        <span class="icon">üîç</span>
        <input
          type="text"
          [(ngModel)]="termoBusca"
          (input)="filtrarOS()"
          placeholder="Buscar placa, cliente ou ID..."
        />
      </div>

      <button class="btn-primary" (click)="abrirModalNovaOS()">
        <span class="icon">+</span> Nova O.S.
      </button>
    </div>
  </div>

  <div class="content-area">
    <div class="card-table">
      <table>
        <thead>
          <tr>
            <th>N¬∫</th>
            <th>Status</th>
            <th>Cliente</th>
            <th>Ve√≠culo</th>
            <th>Data</th>
            <th>Total</th>
            <th class="text-right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="listaOS.length === 0">
            <td colspan="7" style="text-align: center; padding: 30px; color: #888">
              Nenhuma O.S. encontrada.
            </td>
          </tr>

          <tr *ngFor="let os of listaOS">
            <td class="id-col">#{{ os.id }}</td>
            <td>
              <span
                class="status-badge"
                [class.aberta]="os.status === 'ABERTA'"
                [class.finalizada]="os.status === 'FINALIZADA'"
              >
                {{ os.status }}
              </span>
            </td>
            <td class="fw-bold">{{ os.nomeCliente }}</td>

            <td>
              {{ os.modeloVeiculo }} <small class="placa">{{ os.placaVeiculo }}</small>
            </td>

            <td>{{ os.dataAbertura | date : 'dd/MM/yyyy' }}</td>

            <td class="valor">R$ {{ os.totalGeral | number : '1.2-2' }}</td>

            <td class="actions-cell">
              <button class="btn-icon view" (click)="abrirModalDetalhes(os)" title="Ver">üëÅÔ∏è</button>
              <button class="btn-icon delete" (click)="deletarOS(os.id)" title="Excluir">üóëÔ∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalAberto && osSelecionada">
  <div class="modal-papel">
    <div class="print-header-only">
      <h1>NITROGESTOR</h1>
      <p>Relat√≥rio T√©cnico de Servi√ßo</p>
    </div>

    <div class="modal-header">
      <h2>O.S. #{{ osSelecionada.id }}</h2>
      <button class="btn-fechar" (click)="fecharModal()">‚úñ</button>
    </div>

    <div class="detalhes-grid">
      <div class="grupo">
        <label>Cliente</label>
        <p>{{ osSelecionada.nomeCliente }}</p>
      </div>
      <div class="grupo">
        <label>Total</label>
        <p>R$ {{ osSelecionada.totalGeral | number : '1.2-2' }}</p>
      </div>
    </div>

    <div class="problema-box">
      <label>Defeito:</label>
      <p>{{ osSelecionada.defeitoRelatado }}</p>
    </div>

    <hr />

    <div class="area-listas">
      <div class="lista-secao">
        <div class="titulo-secao">
          <h3>üîß Servi√ßos & M√£o de Obra</h3>
          <button class="btn-mini" (click)="abrirModalServico()">+ Add</button>
        </div>

        <table class="tabela-interna">
          <thead>
            <tr>
              <th>Descri√ß√£o</th>
              <th>Mec√¢nico</th>
              <th class="text-right">Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let servico of osSelecionada.servicos">
              <td>{{ servico.descricao }}</td>
              <td>
                <span class="badge-mecanico">{{ servico.nomeMecanico }}</span>
              </td>
              <td class="text-right">R$ {{ servico.valor | number : '1.2-2' }}</td>
            </tr>
            <tr *ngIf="!osSelecionada.servicos.length">
              <td colspan="3" class="text-center text-muted">Nenhum servi√ßo lan√ßado.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="lista-secao mt-4">
        <div class="titulo-secao">
          <h3>üì¶ Pe√ßas Utilizadas</h3>
          <div>
            <button class="btn-mini" (click)="abrirModalPeca()">+ Add</button>
          </div>
        </div>

        <table class="tabela-interna">
          <thead>
            <tr>
              <th>Produto/Pe√ßa</th>
              <th class="text-center">Qtd</th>
              <th class="text-right">Vl. Unit.</th>
              <th class="text-right">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let peca of osSelecionada.pecas">
              <td>{{ peca.nomePeca }}</td>
              <td class="text-center">{{ peca.qtd }}</td>
              <td class="text-right">R$ {{ peca.valorUn | number : '1.2-2' }}</td>
              <td class="text-right fw-bold">R$ {{ peca.subtotal | number : '1.2-2' }}</td>
            </tr>
            <tr *ngIf="!osSelecionada.pecas.length">
              <td colspan="4" class="text-center text-muted">Nenhuma pe√ßa utilizada.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <hr />

    <div class="area-total">
      <div class="resumo-valores">
        <small>Servi√ßos: R$ {{ osSelecionada.totalServicos | number : '1.2-2' }}</small>
        <small>Pe√ßas: R$ {{ osSelecionada.totalPecas | number : '1.2-2' }}</small>
      </div>
      <div class="total-big">
        <span>Total Geral:</span>
        <h1>R$ {{ osSelecionada.totalGeral | number : '1.2-2' }}</h1>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-imprimir" (click)="imprimirOS()">üñ®Ô∏è Imprimir</button>
      <button class="btn-finalizar">‚úÖ Finalizar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalNovaOSAberto">
  <div class="modal-papel modal-cadastro">
    <div class="modal-header">
      <h2>Abrir Nova Ordem de Servi√ßo</h2>
      <button class="btn-fechar" (click)="fecharModalNovaOS()">‚úñ</button>
    </div>

    <div class="form-grid">
      <div class="grupo-form">
        <label>Ve√≠culo / Cliente</label>
        <select [(ngModel)]="dadosNovaOS.veiculoId" class="input-padrao">
          <option [ngValue]="null" disabled>Selecione um ve√≠culo...</option>
          <option *ngFor="let v of listaVeiculos" [ngValue]="v.id">
            {{ v.modelo }} - {{ v.placa }} ({{ v.cliente?.nome || 'Sem Dono' }})
          </option>
        </select>
      </div>

      <div class="grupo-form full-width">
        <label>Defeito Relatado</label>
        <textarea
          [(ngModel)]="dadosNovaOS.defeitoRelatado"
          rows="4"
          class="input-padrao"
          placeholder="Descreva o problema do carro..."
        >
        </textarea>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancelar" (click)="fecharModalNovaOS()">Cancelar</button>
      <button class="btn-salvar" (click)="salvarNovaOS()">üöÄ Abrir O.S.</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalAddServicoAberto" style="z-index: 1100">
  <div class="modal-papel pequena">
    <h3>Adicionar Servi√ßo</h3>
    <div class="form-grid">
      <div class="grupo-form">
        <label>Descri√ß√£o do Servi√ßo</label>
        <input
          type="text"
          [(ngModel)]="dadosServico.descricao"
          class="input-padrao"
          placeholder="Ex: Troca de √ìleo"
        />
      </div>
      <div class="grupo-form">
        <label>Mec√¢nico Respons√°vel</label>
        <select [(ngModel)]="dadosServico.mecanicoId" class="input-padrao">
          <option [ngValue]="null">Selecione...</option>
          <option *ngFor="let m of listaMecanicos" [ngValue]="m.id">{{ m.nome }}</option>
        </select>
      </div>
      <div class="grupo-form">
        <label>Valor (R$)</label>
        <input type="number" [(ngModel)]="dadosServico.valor" class="input-padrao" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancelar" (click)="fecharModalServico()">Cancelar</button>
      <button class="btn-salvar" (click)="salvarServico()">Salvar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalAddPecaAberto" style="z-index: 1100">
  <div class="modal-papel pequena">
    <h3>Adicionar Pe√ßa</h3>
    <div class="form-grid">
      <div class="grupo-form">
        <label>Produto</label>
        <select [(ngModel)]="dadosPeca.produtoId" class="input-padrao">
          <option [ngValue]="null">Selecione a pe√ßa...</option>
          <option *ngFor="let p of listaProdutos" [ngValue]="p.id">
            {{ p.nome }} (Estoque: {{ p.quantidadeEstoque }}) - R$ {{ p.valorVenda }}
          </option>
        </select>
      </div>
      <div class="grupo-form">
        <label>Quantidade</label>
        <input type="number" [(ngModel)]="dadosPeca.quantidade" class="input-padrao" min="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancelar" (click)="fecharModalPeca()">Cancelar</button>
      <button class="btn-salvar" (click)="salvarPeca()">Salvar</button>
    </div>
  </div>
</div>
