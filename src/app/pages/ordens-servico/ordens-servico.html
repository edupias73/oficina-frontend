<div class="page-container">
  <div class="page-toolbar">
    <div class="toolbar-left">
      <h1>Ordens de Servi√ßo</h1>
      <p>Gerencie os servi√ßos e or√ßamentos da oficina.</p>
    </div>

    <div class="toolbar-actions">
      <div class="search-box">
        <span class="icon">üîç</span>
        <input
          type="text"
          [(ngModel)]="termoBusca"
          (input)="filtrarOS()"
          placeholder="Buscar placa, cliente ou ID..."
        />
      </div>

      <button class="btn-primary" (click)="abrirModalNovaOS()">
        <span class="icon">+</span> Nova O.S.
      </button>
    </div>
  </div>

  <div class="content-area">
    <div class="card-table">
      <table>
        <thead>
          <tr>
            <th>N¬∫</th>
            <th>Status</th>
            <th>Cliente</th>
            <th>Ve√≠culo</th>
            <th>Data</th>
            <th>Total</th>
            <th class="text-right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="listaOS.length === 0">
            <td colspan="7" style="text-align: center; padding: 30px; color: #888">
              Nenhuma O.S. encontrada.
            </td>
          </tr>

          <tr *ngFor="let os of listaOS">
            <td class="id-col">#{{ os.id }}</td>
            <td>
              <span
                class="status-badge"
                [class.aberta]="os.status === 'ABERTA'"
                [class.finalizada]="os.status === 'FINALIZADA'"
              >
                {{ os.status }}
              </span>
            </td>
            <td class="fw-bold">{{ os.nomeCliente }}</td>
            <td>
              {{ os.modeloVeiculo }} <small class="placa">{{ os.placaVeiculo }}</small>
            </td>
            <td>{{ os.dataAbertura | date : 'dd/MM/yyyy' }}</td>
            <td class="valor">R$ {{ os.totalGeral | number : '1.2-2' }}</td>
            <td class="actions-cell">
              <button class="btn-icon view" (click)="abrirModalDetalhes(os)" title="Ver Detalhes">üëÅÔ∏è</button>
              <button class="btn-icon delete" (click)="deletarOS(os.id)" title="Excluir O.S.">üóëÔ∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalNovaOSAberto" style="z-index: 1050;">
  <div class="modal-papel modal-cadastro">
    
    <div class="modal-header">
      <h2 *ngIf="!modoExpress">Nova O.S. <small>(Passo {{ passoAtual }}/2)</small></h2>
      <h2 *ngIf="modoExpress">‚ö° O.S. R√°pida (Balc√£o)</h2>
      <button class="btn-fechar" (click)="fecharModalNovaOS()">‚úñ</button>
    </div>

    <div class="passo-container" *ngIf="passoAtual === 1 && !modoExpress">
      
      <div style="text-align: center; margin-bottom: 25px;">
        <button class="btn-express" (click)="ativarModoExpress()">
          ‚ö° Cliente Novo? Criar O.S. Direto
        </button>
      </div>

      <div class="search-hero">
        <label>Ou busque um cliente j√° cadastrado:</label>
        <div class="input-group-search">
          <input 
            type="text" 
            [(ngModel)]="termoBuscaCliente" 
            (input)="buscarComDelay()"
            placeholder="Digite nome ou CPF..." 
            class="input-big" autofocus
          >
          <button class="btn-search" (click)="buscarCliente()">
            {{ buscando ? '‚è≥' : 'üîç' }}
          </button>
        </div>
      </div>

      <div class="lista-resultados" *ngIf="listaClientesEncontrados.length > 0">
        <p class="text-muted" style="margin-bottom: 5px;">Selecione o cliente abaixo:</p>
        <div 
          class="card-cliente" 
          *ngFor="let cliente of listaClientesEncontrados"
          (click)="selecionarCliente(cliente)"
        >
          <strong>{{ cliente.nome }}</strong>
          <span>{{ cliente.documento || 'Sem doc' }}</span>
        </div>
      </div>
    </div>

    <div class="passo-container" *ngIf="modoExpress">
      <div class="alert-info">
        üìù Preencha os dados. O sistema cria Cliente, Carro e O.S. de uma vez!
      </div>

      <div class="form-grid mt-3">
        <div class="grupo-form full-width">
          <label>Nome do Cliente *</label>
          <input type="text" [(ngModel)]="dadosExpress.nomeCliente" class="input-padrao" placeholder="Ex: Jo√£o da Silva">
        </div>
        <div class="grupo-form">
          <label>Telefone</label>
          <input type="text" [(ngModel)]="dadosExpress.telefone" class="input-padrao" placeholder="(45) 9...">
        </div>
        
        <div class="grupo-form">
          <label>Placa do Carro *</label>
          <input type="text" [(ngModel)]="dadosExpress.placa" class="input-padrao" placeholder="ABC-1234">
        </div>
        <div class="grupo-form">
          <label>Modelo</label>
          <input type="text" [(ngModel)]="dadosExpress.modelo" class="input-padrao" placeholder="Gol, Palio...">
        </div>
        <div class="grupo-form">
          <label>Cor</label>
          <input type="text" [(ngModel)]="dadosExpress.cor" class="input-padrao">
        </div>

        <div class="grupo-form full-width">
          <label>Defeito / Servi√ßo *</label>
          <textarea [(ngModel)]="dadosExpress.defeito" rows="3" class="input-padrao" placeholder="O que precisa fazer?"></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-cancelar" (click)="cancelarExpress()">Voltar</button>
        <button class="btn-salvar" (click)="salvarOSExpress()">‚úÖ Criar Tudo</button>
      </div>
    </div>

    <div class="passo-container" *ngIf="passoAtual === 2 && !modoExpress">
      <div class="cliente-selecionado-box">
        <span>Cliente: <strong>{{ clienteSelecionado?.nome }}</strong></span>
        <button class="btn-link" (click)="voltarParaBusca()">Trocar</button>
      </div>

      <div class="form-grid mt-3">
        <div class="grupo-form full-width" *ngIf="!exibirFormVeiculo">
          <div class="flex-between">
            <label>Qual ve√≠culo ser√° consertado?</label>
            <button class="btn-mini-action" (click)="toggleFormVeiculo()">+ Novo Carro</button>
          </div>
          
          <select [(ngModel)]="dadosNovaOS.veiculoId" class="input-padrao" *ngIf="listaVeiculosDoCliente.length > 0">
            <option [ngValue]="null" disabled>Selecione...</option>
            <option *ngFor="let v of listaVeiculosDoCliente" [ngValue]="v.id">
              {{ v.modelo }} - {{ v.placa }}
            </option>
          </select>

          <div class="alert-warning" *ngIf="listaVeiculosDoCliente.length === 0">
            ‚ö†Ô∏è Cliente sem ve√≠culos! <button class="btn-link-strong" (click)="toggleFormVeiculo()">Cadastrar</button>
          </div>
        </div>

        <div class="box-cadastro-rapido full-width" *ngIf="exibirFormVeiculo">
          <h4>üöô Novo Ve√≠culo para {{ clienteSelecionado?.nome }}</h4>
          <div class="grid-rapido">
            <input type="text" [(ngModel)]="novoVeiculoRapido.modelo" placeholder="Modelo" class="input-padrao">
            <input type="text" [(ngModel)]="novoVeiculoRapido.placa" placeholder="Placa" class="input-padrao">
            <input type="text" [(ngModel)]="novoVeiculoRapido.cor" placeholder="Cor" class="input-padrao">
          </div>
          <div class="actions-rapido">
            <button class="btn-cancelar small" (click)="toggleFormVeiculo()">Cancelar</button>
            <button class="btn-salvar small" (click)="salvarVeiculoRapido()">Salvar</button>
          </div>
        </div>

        <div class="grupo-form full-width" *ngIf="!exibirFormVeiculo">
          <label>Defeito Relatado</label>
          <textarea [(ngModel)]="dadosNovaOS.defeitoRelatado" rows="3" class="input-padrao"></textarea>
        </div>
      </div>

      <div class="modal-actions" *ngIf="!exibirFormVeiculo">
        <button class="btn-cancelar" (click)="voltarParaBusca()">Voltar</button>
        <button class="btn-salvar" (click)="salvarNovaOS()" [disabled]="!dadosNovaOS.veiculoId">üöÄ Abrir O.S.</button>
      </div>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="modalAberto && osSelecionada" style="z-index: 1000;">
  <div class="modal-papel">
    <div class="print-header-only"><h1>NITROGESTOR</h1><p>Relat√≥rio T√©cnico</p></div>
    
    <div class="modal-header">
      <h2>O.S. #{{ osSelecionada.id }} <span *ngIf="osSelecionada.status === 'FINALIZADA'" style="color:red; font-size:0.8em">(FINALIZADA)</span></h2>
      <button class="btn-fechar" (click)="fecharModal()">‚úñ</button>
    </div>
    
    <div class="detalhes-grid">
      <div class="grupo"><label>Cliente</label><p>{{ osSelecionada.nomeCliente }}</p></div>
      <div class="grupo"><label>Ve√≠culo</label><p>{{ osSelecionada.modeloVeiculo }} ({{ osSelecionada.placaVeiculo }})</p></div>
    </div>
    
    <div class="problema-box"><label>Defeito:</label><p>{{ osSelecionada.defeitoRelatado }}</p></div>
    
    <hr />
    
    <div class="area-listas">
      <div class="lista-secao">
        <div class="titulo-secao">
            <h3>üîß Servi√ßos</h3>
            <button class="btn-mini" (click)="abrirModalServico()" *ngIf="osSelecionada.status !== 'FINALIZADA'">+ Add</button>
        </div>
        <table class="tabela-interna">
          <tr *ngFor="let s of osSelecionada.servicos">
            <td>
              {{ s.descricao }} 
              <small style="display:block; color:#666">Mec√¢nico: {{ s.nomeMecanico }}</small>
            </td>
            <td class="text-right">R$ {{ s.valor | number:'1.2-2' }}</td>
            <td style="width: 40px; text-align: center;">
              <button class="btn-icon delete" (click)="deletarServico(s.id)" title="Remover" 
                      *ngIf="osSelecionada.status !== 'FINALIZADA'"
                      style="border:none; background:none; cursor:pointer; font-size:1.1rem;">üóëÔ∏è</button>
            </td>
          </tr>
        </table>
      </div>

      <div class="lista-secao mt-4">
        <div class="titulo-secao">
            <h3>üì¶ Pe√ßas</h3>
            <button class="btn-mini" (click)="abrirModalPeca()" *ngIf="osSelecionada.status !== 'FINALIZADA'">+ Add</button>
        </div>
        <table class="tabela-interna">
          <tr *ngFor="let p of osSelecionada.pecas">
            <td>{{ p.nomePeca }}</td>
            <td class="text-center">{{ p.qtd }}x</td>
            <td class="text-right">R$ {{ p.subtotal | number:'1.2-2' }}</td>
            <td style="width: 40px; text-align: center;">
              <button class="btn-icon delete" (click)="deletarPeca(p.id)" title="Remover" 
                      *ngIf="osSelecionada.status !== 'FINALIZADA'"
                      style="border:none; background:none; cursor:pointer; font-size:1.1rem;">üóëÔ∏è</button>
            </td>
          </tr>
        </table>
      </div>
    </div>
    
    <hr />
    
    <div class="area-total">
      <div class="total-big"><span>Total:</span><h1>R$ {{ osSelecionada.totalGeral | number:'1.2-2' }}</h1></div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-imprimir" (click)="imprimirOS()">üñ®Ô∏è Imprimir</button>
      
      <button class="btn-finalizar" (click)="finalizarOS()" *ngIf="osSelecionada.status !== 'FINALIZADA'">‚úÖ Finalizar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalAddServicoAberto" style="z-index: 1100">
    <div class="modal-papel pequena">
      <h3>Adicionar Servi√ßo</h3>
      <div class="form-grid">
        <div class="grupo-form"><label>Descri√ß√£o</label><input type="text" [(ngModel)]="dadosServico.descricao" class="input-padrao"></div>
        <div class="grupo-form">
          <label>Mec√¢nico</label>
          <select [(ngModel)]="dadosServico.mecanicoId" class="input-padrao">
            <option *ngFor="let m of listaMecanicos" [ngValue]="m.id">{{ m.nome }}</option>
          </select>
        </div>
        <div class="grupo-form"><label>Valor</label><input type="number" [(ngModel)]="dadosServico.valor" class="input-padrao"></div>
      </div>
      <div class="modal-actions"><button class="btn-cancelar" (click)="fecharModalServico()">Cancelar</button><button class="btn-salvar" (click)="salvarServico()">Salvar</button></div>
    </div>
</div>

<div class="modal-overlay" *ngIf="modalAddPecaAberto" style="z-index: 1100">
    <div class="modal-papel pequena">
      <h3>Adicionar Pe√ßa</h3>
      <div class="form-grid">
        <div class="grupo-form">
          <label>Pe√ßa</label>
          <select [(ngModel)]="dadosPeca.produtoId" class="input-padrao">
            <option *ngFor="let p of listaProdutos" [ngValue]="p.id">
              {{ p.nome }} (Estoque: {{p.quantidadeEstoque}})
            </option>
          </select>
        </div>
        <div class="grupo-form"><label>Qtd</label><input type="number" [(ngModel)]="dadosPeca.quantidade" class="input-padrao"></div>
      </div>
      <div class="modal-actions"><button class="btn-cancelar" (click)="fecharModalPeca()">Cancelar</button><button class="btn-salvar" (click)="salvarPeca()">Salvar</button></div>
    </div>
</div>